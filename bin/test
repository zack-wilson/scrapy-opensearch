#!/usr/bin/env bash
# Usage: ./bin/test
set -x -euo pipefail

command -v docker || exit 1

function build {
    docker-compose build scrapy
}

function start() {
    docker-compose up --wait opensearch
}

function stop() {
    docker-compose down --remove-orphans --volumes
}

function check() {
    curl --silent --fail -k --retry 10  --retry-all-errors -u admin:admin https://0:9200 || ( stop && exit 1 )
}

function test() {
    docker-compose run scrapy
}

start && check && test && stop
